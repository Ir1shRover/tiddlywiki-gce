#!/bin/sh

# MIT License
# Copyright (c) 2018 Nicola Worthington <nicolaw@tfb.net>

set -ex

# Should we set DOMAIN to the external IP if it is not set?
#export DOMAIN="$(curl -H "Metadata-Flavor: Google" "http://metadata.google.internal/computeMetadata/v1/instance/network-interfaces/0/access-configs/0/external-ip")"

env

if ! grep -qE '^[^:]:.+' /usr/local/apache2/conf/tiddlywiki.passwd 2> /dev/null \
    && [ -n "$TW_USERNAME" ] && [ "$TW_PASSWORD" ] ; then
  htpasswd -c -b -B \
    /usr/local/apache2/conf/tiddlywiki.passwd \
    "$TW_USERNAME" \
    "$TW_PASSWORD"
fi

while [ ! -e /etc/letsencrypt/live/$DOMAIN/cert.pem ]
do
  echo "Waiting for SSL certificate to be generated ..."
  sleep 5
done

exec httpd -D FOREGROUND
